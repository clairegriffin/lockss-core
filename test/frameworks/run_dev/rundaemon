#! /bin/sh

group="dev"

arg_mem="-Xmx1g"

prop_url="http://props.lockss.org:8001/daemon/lockss.xml"
CLASSPATH=lib/current.jar:`cat ${PROJECT_DIR}/target/test-classpath`

while true ; do
  case "$1" in
    "-classpath" )
      CLASSPATH="$2"
      echo "CLASSPATH=$CLASSPATH"
      shift; shift; continue;;
    "-debug" )
      args="$args -Dorg.lockss.defaultLogLevel=DEBUG"
      shift; continue;;
    "-debug2" )
      args="$args -Dorg.lockss.defaultLogLevel=DEBUG2"
      shift; continue;;
    "-debug3" )
      args="$args -Dorg.lockss.defaultLogLevel=DEBUG3"
      shift; continue;;
    "-g" )
      group="$2"
      echo "group=$group"
      shift; shift; continue;;
    "-1.7" )
      if [ -z "$JAVA_17_HOME" ] ; then
	echo "-1.7 option requires JAVA_17_HOME to point to 1.7 install dir"
	exit 1;
      fi
      JAVA_HOME="${JAVA_17_HOME}"
      export JAVA_HOME
      PATH="$JAVA_HOME/bin:$PATH"
      export PATH
      echo JAVA_HOME="$JAVA_HOME"
      shift; continue;;
    "-1.8" )
      if [ -z "$JAVA_18_HOME" ] ; then
	echo "-1.8 option requires JAVA_18_HOME to point to 1.8 install dir"
	exit 1;
      fi
      JAVA_HOME="${JAVA_18_HOME}"
      export JAVA_HOME
      PATH="$JAVA_HOME/bin:$PATH"
      export PATH
      echo JAVA_HOME="$JAVA_HOME"
      shift; continue;;
    "-1.9" )
      if [ -z "$JAVA_19_HOME" ] ; then
	echo "-1.9 option requires JAVA_19_HOME to point to 1.9 install dir"
	exit 1;
      fi
      JAVA_HOME="${JAVA_19_HOME}"
      export JAVA_HOME
      PATH="$JAVA_HOME/bin:$PATH"
      export PATH
      echo JAVA_HOME="$JAVA_HOME"
      shift; continue;;
    -Xmx* )
      arg_mem="$1"
      shift; continue;;
    -p )
      prop_url="$2"
      shift; shift; continue;;
    -* )
      args="$args $1"
      shift; continue;;
  esac
  break;
done

if [ -z "$args" ]; then
  args="-server -Dorg.lockss.defaultLogLevel=DEBUG"
  PATH="$JAVA_HOME/bin:$PATH"
fi

PROP_URL_LIST="-p $prop_url -p local.txt"

# local copy of lockss jars allows recompile while we're running
mkdir -p lib
cp "${PROJECT_DIR}/target/current.jar" lib
cp "${PROJECT_DIR}/target/current-tests.jar" lib
#cp "${PROJECT_DIR}/lib/lockss-plugins.jar" lib
export CLASSPATH
#echo CLASSPATH=$CLASSPATH

echo running at `date`
java $args $arg_mem -Dsun.net.inetaddr.ttl=3600 org.lockss.app.LockssDaemon -g $group ${PROP_URL_LIST} >>test.out 2>&1 &
echo $! >dpid
wait `cat dpid`
echo stopped with status $? at `date`
